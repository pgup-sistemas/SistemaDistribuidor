{% extends "base.html" %}

{% block title %}Relatório de Vendas - Sistema Distribuidor{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line"></i> Relatório de Vendas</h1>
        <div class="btn-group">
            <a href="{{ url_for('reports.sales', start_date=start_date, end_date=end_date, export='csv') }}" 
               class="btn btn-success">
                <i class="fas fa-file-csv"></i> Exportar CSV
            </a>
            <a href="{{ url_for('reports.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
    
    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row align-items-end">
                <div class="col-md-4">
                    <label for="start_date" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                </div>
                <div class="col-md-4">
                    <label for="end_date" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>R$ {{ "%.2f"|format(total_sales) }}</h4>
                            <p class="mb-0">Total de Vendas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_orders }}</h4>
                            <p class="mb-0">Total de Pedidos</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Daily Sales Chart -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Vendas Diárias</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailySalesChart" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Payment Methods -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-credit-card"></i> Por Método de Pagamento</h5>
                </div>
                <div class="card-body">
                    {% for payment in payment_sales %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>
                            {% if payment.payment_method == 'cash' %}Dinheiro
                            {% elif payment.payment_method == 'card' %}Cartão
                            {% elif payment.payment_method == 'pix' %}PIX
                            {% elif payment.payment_method == 'bank_slip' %}Boleto
                            {% else %}{{ payment.payment_method }}{% endif %}
                        </span>
                        <div class="text-end">
                            <div>R$ {{ "%.2f"|format(payment.total) }}</div>
                            <small class="text-muted">{{ payment.orders }} pedidos</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Orders -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Detalhamento de Pedidos</h5>
        </div>
        <div class="card-body">
            {% if orders %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Pagamento</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>
                                <a href="{{ url_for('orders.view', id=order.id) }}" class="text-decoration-none">
                                    #{{ order.id }}
                                </a>
                            </td>
                            <td>{{ order.created_at.strftime('%d/%m/%Y %H:%M') if order.created_at else 'N/A' }}</td>
                            <td>{{ order.customer.name }}</td>
                            <td>
                                {% if order.payment_method == 'cash' %}Dinheiro
                                {% elif order.payment_method == 'card' %}Cartão
                                {% elif order.payment_method == 'pix' %}PIX
                                {% elif order.payment_method == 'bank_slip' %}Boleto
                                {% else %}{{ order.payment_method }}{% endif %}
                            </td>
                            <td>R$ {{ "%.2f"|format(order.total) }}</td>
                            <td>
                                <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'confirmed' %}primary{% elif order.status == 'preparing' %}info{% elif order.status == 'pending' %}warning{% else %}secondary{% endif %} text-uppercase">
                                    {{ order.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5>Nenhuma venda encontrada</h5>
                <p class="text-muted">Não há vendas no período selecionado.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Daily Sales Chart
const ctx = document.getElementById('dailySalesChart').getContext('2d');
const dailySales = {{ daily_sales | tojson }};

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: dailySales.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }),
        datasets: [{
            label: 'Vendas (R$)',
            data: dailySales.map(item => parseFloat(item.total || 0)),
            backgroundColor: 'rgba(75, 192, 192, 0.8)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toFixed(2);
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Vendas: R$ ' + context.parsed.y.toFixed(2);
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
