<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazer Pedido - {{ config.COMPANY_NAME or 'Sistema Distribuidor' }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .product-card {
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
        }
        
        .product-card.selected {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .cart-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            border-color: #25D366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
            border-color: #128C7E;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('public.index') }}">
                <i class="fas fa-store"></i> {{ config.COMPANY_NAME or 'Sistema Distribuidor' }}
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('public.index') }}">
                    <i class="fas fa-home"></i> InÃ­cio
                </a>
                <a class="nav-link" href="{{ url_for('public.menu') }}">
                    <i class="fas fa-list"></i> CardÃ¡pio
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <!-- Produtos -->
            <div class="col-lg-8">
                <h2 class="mb-4">
                    <i class="fas fa-shopping-cart"></i> FaÃ§a Seu Pedido
                </h2>
                
                <!-- Filtros -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <input type="text" id="searchProducts" class="form-control" placeholder="Buscar produtos...">
                    </div>
                    <div class="col-md-6">
                        <select id="categoryFilter" class="form-select">
                            <option value="">Todas as categorias</option>
                            <!-- Categorias serÃ£o carregadas via JavaScript -->
                        </select>
                    </div>
                </div>
                
                <!-- Lista de Produtos -->
                <div class="row" id="productsList">
                    <!-- Produtos serÃ£o carregados via JavaScript -->
                </div>
            </div>
            
            <!-- Carrinho -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-bag"></i> Seu Pedido
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="cartItems">
                            <p class="text-muted text-center">Nenhum item adicionado</p>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <strong>Total:</strong>
                            <strong id="cartTotal">R$ 0,00</strong>
                        </div>
                        
                        <button type="button" class="btn btn-primary w-100 mb-3" onclick="proceedToCheckout()" disabled id="checkoutBtn">
                            <i class="fas fa-credit-card"></i> Finalizar Pedido
                        </button>
                        
                        <a href="{{ url_for('public.menu') }}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-list"></i> Ver CardÃ¡pio Completo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de FinalizaÃ§Ã£o -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shopping-cart"></i> Finalizar Pedido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="checkoutForm" method="POST" action="{{ url_for('public.create_order') }}">
                    <div class="modal-body">
                        <!-- Dados do Cliente -->
                        <h6 class="fw-bold mb-3">Dados do Cliente</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="customer_name" class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="customer_phone" class="form-label">Telefone/WhatsApp *</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="customer_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email">
                            </div>
                            <div class="col-md-6">
                                <label for="customer_cep" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="customer_cep" name="customer_cep">
                            </div>
                            <div class="col-12">
                                <label for="customer_address" class="form-label">EndereÃ§o</label>
                                <input type="text" class="form-control" id="customer_address" name="customer_address">
                            </div>
                            <div class="col-md-6">
                                <label for="customer_neighborhood" class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="customer_neighborhood" name="customer_neighborhood">
                            </div>
                            <div class="col-md-4">
                                <label for="customer_city" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="customer_city" name="customer_city">
                            </div>
                            <div class="col-md-2">
                                <label for="customer_state" class="form-label">UF</label>
                                <input type="text" class="form-control" id="customer_state" name="customer_state" maxlength="2">
                            </div>
                        </div>
                        
                        <!-- MÃ©todo de Pagamento -->
                        <h6 class="fw-bold mb-3">MÃ©todo de Pagamento</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <select class="form-select" id="payment_method" name="payment_method" required>
                                    <option value="">Selecionar mÃ©todo</option>
                                    <option value="cash">ðŸ’µ Dinheiro</option>
                                    <option value="card">ðŸ’³ CartÃ£o</option>
                                    <option value="pix">ðŸ“± PIX</option>
                                    <option value="bank_slip">ðŸ“„ Boleto</option>
                                    <option value="mercadopago">ðŸ’³ MercadoPago (Online)</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="notes" class="form-label">ObservaÃ§Ãµes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="ObservaÃ§Ãµes sobre o pedido..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Resumo do Pedido -->
                        <h6 class="fw-bold mb-3">Resumo do Pedido</h6>
                        <div id="orderSummary">
                            <!-- Resumo serÃ¡ preenchido via JavaScript -->
                        </div>
                        
                        <input type="hidden" id="items" name="items">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-whatsapp">
                            <i class="fab fa-whatsapp"></i> Confirmar Pedido
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let cart = [];
        let products = [];
        let categories = [];
        
        // Carregar produtos
        async function loadProducts() {
            try {
                const response = await fetch('/public/api/products');
                products = await response.json();
                
                // Extrair categorias Ãºnicas
                categories = [...new Set(products.map(p => p.category_name).filter(Boolean))];
                
                renderProducts();
                renderCategoryFilter();
                updateCartDisplay();
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }
        
        // Renderizar filtro de categorias
        function renderCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">Todas as categorias</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }
        
        // Renderizar produtos
        function renderProducts() {
            const container = document.getElementById('productsList');
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            // Filtrar produtos
            let filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                    (product.description && product.description.toLowerCase().includes(searchTerm));
                const matchesCategory = !selectedCategory || product.category_name === selectedCategory;
                return matchesSearch && matchesCategory;
            });
            
            container.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">Nenhum produto encontrado.</div></div>';
                return;
            }
            
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'col-md-6 col-lg-4 mb-3';
                productCard.innerHTML = `
                    <div class="card product-card h-100" onclick="addToCart(${product.id})">
                        ${product.image_url ? `
                            <img src="${product.image_url}" class="card-img-top" alt="${product.name}" 
                                 style="height: 150px; object-fit: cover;">
                        ` : `
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                                 style="height: 150px;">
                                <i class="fas fa-image fa-2x text-muted"></i>
                            </div>
                        `}
                        <div class="card-body">
                            <h6 class="card-title">${product.name}</h6>
                            <p class="card-text text-muted small">${product.description || ''}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-primary">R$ ${product.price.toFixed(2)}</span>
                                <small class="text-muted">Estoque: ${product.stock_quantity}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(productCard);
            });
        }
        
        // Adicionar ao carrinho
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.product_id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    product_id: productId,
                    name: product.name,
                    unit_price: product.price,
                    quantity: 1,
                    discount: 0
                });
            }
            
            updateCartDisplay();
        }
        
        // Remover do carrinho
        function removeFromCart(productId) {
            cart = cart.filter(item => item.product_id !== productId);
            updateCartDisplay();
        }
        
        // Atualizar quantidade
        function updateQuantity(productId, quantity) {
            const item = cart.find(item => item.product_id === productId);
            if (item) {
                if (quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    item.quantity = quantity;
                }
                updateCartDisplay();
            }
        }
        
        // Atualizar exibiÃ§Ã£o do carrinho
        function updateCartDisplay() {
            const container = document.getElementById('cartItems');
            const totalElement = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhum item adicionado</p>';
                totalElement.textContent = 'R$ 0,00';
                checkoutBtn.disabled = true;
                return;
            }
            
            let total = 0;
            let html = '';
            
            cart.forEach(item => {
                const itemTotal = (item.unit_price * item.quantity) - item.discount;
                total += itemTotal;
                
                html += `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${item.name}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.product_id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">-</button>
                                <input type="number" class="form-control text-center" value="${item.quantity}" min="1" onchange="updateQuantity(${item.product_id}, parseInt(this.value))">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">+</button>
                            </div>
                            <span class="fw-bold">R$ ${itemTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            totalElement.textContent = `R$ ${total.toFixed(2)}`;
            checkoutBtn.disabled = false;
        }
        
        // Prosseguir para checkout
        function proceedToCheckout() {
            if (cart.length === 0) return;
            
            // Preencher resumo do pedido
            const summaryContainer = document.getElementById('orderSummary');
            let summaryHtml = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = (item.unit_price * item.quantity) - item.discount;
                total += itemTotal;
                summaryHtml += `
                    <div class="d-flex justify-content-between">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>R$ ${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });
            
            summaryHtml += `
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span>R$ ${total.toFixed(2)}</span>
                </div>
            `;
            
            summaryContainer.innerHTML = summaryHtml;
            
            // Preencher campo hidden com itens
            document.getElementById('items').value = JSON.stringify(cart);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            modal.show();
        }
        
        // MÃ¡scara para telefone
        document.getElementById('customer_phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                if (value.length < 14) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                }
            }
            e.target.value = value;
        });
        
        // MÃ¡scara para CEP
        document.getElementById('customer_cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
            e.target.value = value;
        });
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            
            // Event listeners para filtros
            document.getElementById('searchProducts').addEventListener('input', renderProducts);
            document.getElementById('categoryFilter').addEventListener('change', renderProducts);
        });
    </script>
</body>
</html>
